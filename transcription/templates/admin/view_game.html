{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" type="text/css" href="{% static 'transcription/game_view.css' %}" />
  <style>
    .participants-list {
      margin-top: 20px;
      background-color: rgba(255, 255, 255, 0.8);
      padding: 15px;
      border-radius: 5px;
    }
    .participants-list h2 {
      margin-top: 0;
    }
    .participants-list ul {
      list-style-type: none;
      padding-left: 0;
    }

    .start-game-button {
      background-color: #4CAF50;
      border: none;
      color: white;
      padding: 15px 32px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 4px 2px;
      cursor: pointer;
      border-radius: 5px;
      position: relative;
      z-index: 1000;  /* Ensure the button is above other elements */
    }
  
  </style>
{% endblock %}

{% block content %}
<div id="particles-js"></div>
<div class="container">
  <h1>{{ title }}</h1>
  <div class="game-code">{{ game.code }}</div>
  <div class="info">
    <p>Flashcard Set: {{ game.flashcard_set.name }}</p>
    <p>Created At: {{ game.created_at }}</p>
  </div>
  <button id="start-game" class="start-game-button" {% if game.started %}style="display: none;"{% endif %}>Start Game</button>
  <div id="team-info" {% if not game.started %}style="display: none;"{% endif %}>
    <h2>Teams</h2>
    <ul id="team-list"></ul>
  </div>
  <div class="participants-list">
    <h2>Participants</h2>
    <ul id="participants">
      {% for participant in game.participants.all %}
      <li>
        <span class="participant-sprite">{{ participant.sprite }}</span>
        {{ participant.user.username }}
      </li>
      {% empty %}
      <li id="no-participants">No participants yet.</li>
      {% endfor %}
    </ul>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
<script src="https://js.pusher.com/7.0/pusher.min.js"></script>
<script>
  particlesJS("particles-js", {
    particles: {
      number: { value: 80, density: { enable: true, value_area: 800 } },
      color: { value: "#4a8fe7" },
      shape: { type: "circle" },
      opacity: { value: 0.5, random: false },
      size: { value: 3, random: true },
      line_linked: {
        enable: true,
        distance: 150,
        color: "#4a8fe7",
        opacity: 0.4,
        width: 1,
      },
      move: {
        enable: true,
        speed: 6,
        direction: "none",
        random: false,
        straight: false,
        out_mode: "out",
        bounce: false,
      },
    },
    interactivity: {
      detect_on: "canvas",
      events: {
        onhover: { enable: true, mode: "repulse" },
        onclick: { enable: true, mode: "push" },
        resize: true,
      },
      modes: {
        grab: { distance: 400, line_linked: { opacity: 1 } },
        bubble: { distance: 400, size: 40, duration: 2, opacity: 8, speed: 3 },
        repulse: { distance: 200, duration: 0.4 },
        push: { particles_nb: 4 },
        remove: { particles_nb: 2 },
      },
    },
    retina_detect: true,
  });
// Pusher configuration
const pusher = new Pusher('{{ pusher_key }}', {
  cluster: '{{ pusher_cluster }}',
  encrypted: true
});

const channel = pusher.subscribe('game-{{ game.id }}');
channel.bind('new-participant', function(data) {
  const participantsList = document.getElementById('participants');
  let participantElement = document.getElementById(`participant-${data.username}`);
  
  if (!participantElement) {
    participantElement = document.createElement('li');
    participantElement.id = `participant-${data.username}`;
    participantsList.appendChild(participantElement);
  }
  
  participantElement.innerHTML = `
    <span class="participant-sprite">${data.sprite}</span>
    ${data.username}
  `;
  
  const noParticipantsMessage = document.getElementById('no-participants');
  if (noParticipantsMessage) {
    participantsList.removeChild(noParticipantsMessage);
  }
});
function checkGameStarted() {
  const gameStarted = {% if game.started %}true{% else %}false{% endif %};
  if (gameStarted) {
    document.getElementById('start-game').style.display = 'none';
    document.getElementById('team-info').style.display = 'block';
    fetchTeams();
  }
}

function fetchTeams() {
  fetch('{% url "get_teams" game.id %}')
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        displayTeams(data.teams);
      } else {
        console.error('Failed to fetch teams:', data.message);
      }
    })
    .catch(error => {
      console.error('Error fetching teams:', error);
    });
}

document.addEventListener('DOMContentLoaded', function() {
  checkGameStarted();

  document.getElementById('start-game').addEventListener('click', function() {
    fetch('{% url "start_game" game.id %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json',
      },
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        document.getElementById('start-game').style.display = 'none';
        document.getElementById('team-info').style.display = 'block';
        displayTeams(data.teams);
      } else {
        alert('Failed to start the game. Please try again.');
      }
    });
  });
});

function displayTeams(teams) {
  const teamList = document.getElementById('team-list');
  teamList.innerHTML = '';
  for (const [teamName, teamData] of Object.entries(teams)) {
    const teamItem = document.createElement('li');
    teamItem.innerHTML = `<strong>${teamName}</strong>: ${teamData.members.join(', ')}`;
    teamList.appendChild(teamItem);
  }
}

channel.bind('game-started', function(data) {
  document.getElementById('start-game').style.display = 'none';
  document.getElementById('team-info').style.display = 'block';
  displayTeams(data.teams);
});
</script>
{% endblock %}